<script>
// ============ CONTROLADOR DE FLUJO v1 ============
// Estados persistentes
// tm_subscribed_at: timestamp cuando se suscribe
// tm_intake_done: "true" si guard√≥ el intake
// tm_registro_dias: n√∫mero de d√≠as guardados (0..5)
// tm_informe_ready: "true" cuando se genera el informe

const S = {
  get subAt(){ return Number(localStorage.getItem('tm_subscribed_at')||0); },
  set subAt(v){ localStorage.setItem('tm_subscribed_at', String(v)); },

  get intakeDone(){ return localStorage.getItem('tm_intake_done')==='true'; },
  set intakeDone(v){ localStorage.setItem('tm_intake_done', v?'true':'false'); },

  get dias(){ return Number(localStorage.getItem('tm_registro_dias')||0); },
  set dias(n){ localStorage.setItem('tm_registro_dias', String(Math.max(0, Math.min(5,n)))); },

  get informe(){ return localStorage.getItem('tm_informe_ready')==='true'; },
  set informe(v){ localStorage.setItem('tm_informe_ready', v?'true':'false'); }
};

// Helpers DOM
function $(sel){ return document.querySelector(sel); }
function show(id){ const el=$(id); if(el){ el.style.display='block'; el.style.opacity='1'; el.style.transform='translateY(0)'; } }
function hide(id){ const el=$(id); if(el){ el.style.display='none'; } }

function setText(sel, txt){ const el=$(sel); if(el){ el.textContent = txt; } }

// Render principal del flujo
function renderFlow(){
  // 1) Progreso etiquetas Mes 1
  const dias = S.dias;
  setText('#mes1-progreso', `Progreso diario: ${dias}/5 d√≠as`);
  if (S.subAt){
    const diffDays = Math.max(0, Math.floor((Date.now()-S.subAt)/(1000*60*60*24)));
    setText('#mes1-dias-suscripcion', `D√≠a ${diffDays} desde tu suscripci√≥n`);
  }

  // 2) Bot√≥n Generar Informe visible solo si intakeDone && dias>=5 && !informe
  const btnGen = $('#btnGenerarInforme');
  if(btnGen){
    btnGen.style.display = (S.intakeDone && dias >= 5 && !S.informe) ? 'inline-block' : 'none';
  }

  // 3) Informe visible solo si S.informe==true
  if(S.informe){
    show('#informe-inicial');
  } else {
    hide('#informe-inicial');
  }
}

// Listeners base: marcar estados en los formularios y botones

// Suscripci√≥n: si no existe marca suscripci√≥n (puedes llamarlo tras click al suscribirse)
if(!S.subAt){ S.subAt = Date.now(); }

// Intake submit: marca intakeDone=true y hace scroll al registro
const intakeForm = $('#intakeForm');
if(intakeForm){
  intakeForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    S.intakeDone = true;
    alert("üåø Historial guardado. Gracias por compartir tu informaci√≥n.");
    $('#registro5dias')?.scrollIntoView({behavior:'smooth'});
    renderFlow();
  });
}

// Registro de 5 d√≠as: cada bot√≥n "guardar d√≠a" debe tener la clase .guardar-dia
document.querySelectorAll('.guardar-dia').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(!S.intakeDone){
      alert("Primero completa tu historial (intake).");
      $('#intake')?.scrollIntoView({behavior:'smooth'});
      return;
    }
    if(S.dias < 5){
      S.dias = S.dias + 1;
      alert(`D√≠a registrado ‚úÖ (${S.dias}/5)`);
      renderFlow();
    } else {
      alert("Ya completaste los 5 d√≠as. Genera tu informe.");
    }
  });
});

// Generar informe: set S.informe=true y mostrar el bloque
const btnGenerar = $('#btnGenerarInforme');
if(btnGenerar){
  btnGenerar.addEventListener('click', ()=>{
    if(!(S.intakeDone && S.dias>=5)){
      alert("Completa el intake y los 5 d√≠as para generar el informe.");
      return;
    }
    S.informe = true;
    show('#informe-inicial');
    $('#informe-inicial')?.scrollIntoView({behavior:'smooth'});
    renderFlow();
  });
}

// Bot√≥n final ‚ÄúVer mis recomendaciones iniciales‚Äù debe ir al INFORME, no al diagn√≥stico gratuito
const btnVerRec = $('#verRecomendaciones');
if(btnVerRec){
  btnVerRec.addEventListener('click', ()=>{
    if(!S.informe){
      alert("Tu informe estar√° disponible al completar tus 5 d√≠as y generarlo.");
      return;
    }
    $('#informe-inicial')?.scrollIntoView({behavior:'smooth'});
  });
}

// Primera pintura
renderFlow();
</script>